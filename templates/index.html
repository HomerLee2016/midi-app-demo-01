<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grid MIDI Sequencer</title>
  <link rel="stylesheet" href="/static/style.css">
  <!-- Tone.js for in-browser playback -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>
</head>
<body>
  <h1>Grid MIDI Sequencer</h1>
  <div style="display: flex; justify-content: center; align-items: flex-start;">
    <div id="grid">
      <table>
        <tbody>
          {% set note_labels = ['C3', '', 'D3', '', 'E3', 'F3', '', 'G3', '', 'A3', '', 'B3', 'C4'] %}
          {% for i in range(note_types|length) %}
            <tr class="{{ note_types[i] }}-key">
              {% if note_types[i] == 'white' %}
                <td class="note-label">{{ note_labels[i] }}</td>
              {% else %}
                <td class="note-label"></td>
              {% endif %}
              {% for b in range(beats) %}
                <td>
                  <div class="cell" data-row="{{ i }}" data-col="{{ b }}"></div>
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div style="margin-left: 24px; display: flex; flex-direction: column; align-items: flex-end;">
      <label for="beatSpeed" style="font-size: 0.95em; margin-bottom: 4px;">
        {{ bpm_label }} BPM:
      </label>
      <input type="number" id="beatSpeed" min="30" max="300" value="{{ beat_speed }}" style="width: 60px;">
    </div>
  </div>
  <div class="controls">
    <button id="playBtn">Play</button>
    <button id="saveBtn">Save as MIDI</button>
  </div>
  <script>
    // --- Grid state ---
    const rows = {{ note_types|length }};
    const cols = {{ beats }};
    let grid = Array.from({length: rows}, () => Array(cols).fill(0));

    // --- Cell click handler ---
    document.querySelectorAll('.cell').forEach(cell => {
      cell.addEventListener('click', function() {
        const r = +this.dataset.row, c = +this.dataset.col;
        grid[r][c] = grid[r][c] ? 0 : 1;
        this.classList.toggle('active', !!grid[r][c]);
      });
    });

    // --- Play handler ---
    document.getElementById('playBtn').onclick = async function() {
      await Tone.start();
      const synth = new Tone.PolySynth(Tone.Synth).toDestination();
      const now = Tone.now();
      const midiNotes = [48,49,50,51,52,53,54,55,56,57,58,59,60];
      const bpm = parseInt(document.getElementById('beatSpeed').value) || 120;
      const beatDur = 60 / bpm;
      for (let c = 0; c < cols; ++c) {
        for (let r = 0; r < rows; ++r) {
          if (grid[r][c]) {
            synth.triggerAttackRelease(
              Tone.Frequency(midiNotes[r], "midi"),
              "8n",
              now + c * beatDur
            );
          }
        }
      }
    };

    // --- Save handler ---
    document.getElementById('saveBtn').onclick = async function() {
      const response = await fetch('/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({grid})
      });
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sequence.mid';
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
