<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grid MIDI Sequencer</title>
  <link rel="stylesheet" href="/static/style.css">
  <!-- Tone.js for in-browser playback -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>
</head>
<body>
  <h1>Grid MIDI Sequencer</h1>
  <div style="display: flex; justify-content: center; align-items: flex-start;">
    <div>
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <span style="font-weight: bold;">Track 1</span>
        <select id="track1Instrument" style="margin-left: 12px;">
          {% for opt in instrument_options %}
            <option value="{{ opt.midi }}" {% if opt.midi == track1_instrument %}selected{% endif %}>{{ opt.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="grid1" class="track-grid">
        <table>
          <tbody>
            {% set note_labels = ['C3', '', 'D3', '', 'E3', 'F3', '', 'G3', '', 'A3', '', 'B3', 'C4'] %}
            {% for i in range(note_types|length) %}
              <tr class="{{ note_types[i] }}-key">
                {% if note_types[i] == 'white' %}
                  <td class="note-label">{{ note_labels[i] }}</td>
                {% else %}
                  <td class="note-label"></td>
                {% endif %}
                {% for b in range(beats) %}
                  <td>
                    <div class="cell" data-track="0" data-row="{{ i }}" data-col="{{ b }}"></div>
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="height: 24px;"></div>
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <span style="font-weight: bold;">Track 2</span>
        <select id="track2Instrument" style="margin-left: 12px;">
          {% for opt in instrument_options %}
            <option value="{{ opt.midi }}" {% if opt.midi == track2_instrument %}selected{% endif %}>{{ opt.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="grid2" class="track-grid">
        <table>
          <tbody>
            {% set note_labels = ['C3', '', 'D3', '', 'E3', 'F3', '', 'G3', '', 'A3', '', 'B3', 'C4'] %}
            {% for i in range(note_types|length) %}
              <tr class="{{ note_types[i] }}-key">
                {% if note_types[i] == 'white' %}
                  <td class="note-label">{{ note_labels[i] }}</td>
                {% else %}
                  <td class="note-label"></td>
                {% endif %}
                {% for b in range(beats) %}
                  <td>
                    <div class="cell" data-track="1" data-row="{{ i }}" data-col="{{ b }}"></div>
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div style="margin-left: 24px; display: flex; flex-direction: column; align-items: flex-end;">
      <label for="beatSpeed" style="font-size: 0.95em; margin-bottom: 4px;">
        {{ bpm_label }} BPM:
      </label>
      <input type="number" id="beatSpeed" min="30" max="300" value="{{ beat_speed }}" style="width: 60px;">
    </div>
  </div>
  <div class="controls">
    <button id="playBtn">Play</button>
    <button id="saveBtn">Save as MIDI</button>
    <button id="exportBtn">Export JSON</button>
    <input type="file" id="importInput" accept=".json" style="display:none;">
    <button id="importBtn">Import JSON</button>
  </div>
  <script>
    // --- Grid state ---
    const rows = {{ note_types|length }};
    const cols = {{ beats }};
    let grids = [
      Array.from({length: rows}, () => Array(cols).fill(0)),
      Array.from({length: rows}, () => Array(cols).fill(0))
    ];

    // --- Cell click handler ---
    document.querySelectorAll('.cell').forEach(cell => {
      cell.addEventListener('click', function() {
        const t = +this.dataset.track, r = +this.dataset.row, c = +this.dataset.col;
        grids[t][r][c] = grids[t][r][c] ? 0 : 1;
        this.classList.toggle('active', !!grids[t][r][c]);
      });
    });

    // --- Play handler ---
    document.getElementById('playBtn').onclick = async function() {
      await Tone.start();
      const midiNotes = [48,49,50,51,52,53,54,55,56,57,58,59,60];
      const bpm = parseInt(document.getElementById('beatSpeed').value) || 120;
      const beatDur = 60 / bpm;
      // Instrument mapping for Tone.js
      const toneInstruments = {
        0: () => new Tone.PolySynth(Tone.Synth).toDestination(), // Piano
        40: () => new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" } }).toDestination(), // Violin
        24: () => new Tone.PolySynth(Tone.Synth, { oscillator: { type: "square" } }).toDestination(), // Guitar
        52: () => new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" } }).toDestination() // Vocal Harmony
      };
      const inst1 = parseInt(document.getElementById('track1Instrument').value);
      const inst2 = parseInt(document.getElementById('track2Instrument').value);
      // Create separate synths for each track to avoid overriding
      const synths = [
        (toneInstruments[inst1] || toneInstruments[0])(),
        (toneInstruments[inst2] || toneInstruments[52])()
      ];
      const now = Tone.now();
      for (let t = 0; t < 2; ++t) {
        for (let c = 0; c < cols; ++c) {
          for (let r = 0; r < rows; ++r) {
            if (grids[t][r][c]) {
              synths[t].triggerAttackRelease(
                Tone.Frequency(midiNotes[r], "midi"),
                "8n",
                now + c * beatDur
              );
            }
          }
        }
      }
      // Dispose synths after playback to free resources
      setTimeout(() => {
        synths.forEach(s => s.dispose());
      }, cols * beatDur * 1000 + 500);
    };

    // --- Save handler ---
    document.getElementById('saveBtn').onclick = async function() {
      const inst1 = parseInt(document.getElementById('track1Instrument').value);
      const inst2 = parseInt(document.getElementById('track2Instrument').value);
      const response = await fetch('/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({grids: grids, instruments: [inst1, inst2]})
      });
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sequence.mid';
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    };

    // --- Export handler ---
    document.getElementById('exportBtn').onclick = function() {
      const inst1 = parseInt(document.getElementById('track1Instrument').value);
      const inst2 = parseInt(document.getElementById('track2Instrument').value);
      const bpm = parseInt(document.getElementById('beatSpeed').value) || 120;
      const data = {
        grids: grids,
        instruments: [inst1, inst2],
        bpm: bpm
      };
      const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'track_data.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    // --- Import handler ---
    document.getElementById('importBtn').onclick = function() {
      document.getElementById('importInput').click();
    };
    document.getElementById('importInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const data = JSON.parse(evt.target.result);
          if (data.grids && data.grids.length === 2) {
            grids = data.grids;
            // Update grid UI
            document.querySelectorAll('.cell').forEach(cell => {
              const t = +cell.dataset.track, r = +cell.dataset.row, c = +cell.dataset.col;
              cell.classList.toggle('active', !!grids[t][r][c]);
            });
          }
          if (data.instruments && data.instruments.length === 2) {
            document.getElementById('track1Instrument').value = data.instruments[0];
            document.getElementById('track2Instrument').value = data.instruments[1];
          }
          if (data.bpm) {
            document.getElementById('beatSpeed').value = data.bpm;
          }
        } catch (err) {
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
      // Reset input so same file can be loaded again if needed
      e.target.value = '';
    });
  </script>
</body>
</html>