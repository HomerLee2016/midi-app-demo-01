<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grid MIDI Sequencer</title>
  <link rel="stylesheet" href="/static/style.css">
  <!-- Tone.js for in-browser playback -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>
</head>
<body>
  <h1>Grid MIDI Sequencer</h1>
  <div id="grid">
    <table>
      <tbody>
        {% for i in range(note_types|length) %}
          <tr class="{{ note_types[i] }}-key">
            <td class="note-label">{{ note_types[i] }}</td>
            {% for b in range(beats) %}
              <td>
                <div class="cell" data-row="{{ i }}" data-col="{{ b }}"></div>
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="controls">
    <button id="playBtn">Play</button>
    <button id="saveBtn">Save as MIDI</button>
  </div>
  <script>
    // --- Grid state ---
    const rows = {{ note_types|length }};
    const cols = {{ beats }};
    let grid = Array.from({length: rows}, () => Array(cols).fill(0));

    // --- Cell click handler ---
    document.querySelectorAll('.cell').forEach(cell => {
      cell.addEventListener('click', function() {
        const r = +this.dataset.row, c = +this.dataset.col;
        grid[r][c] = grid[r][c] ? 0 : 1;
        this.classList.toggle('active', !!grid[r][c]);
      });
    });

    // --- Play handler ---
    document.getElementById('playBtn').onclick = async function() {
      await Tone.start();
      const synth = new Tone.PolySynth(Tone.Synth).toDestination();
      const now = Tone.now();
      const midiNotes = [48,49,50,51,52,53,54,55,56,57,58,59,60];
      for (let c = 0; c < cols; ++c) {
        for (let r = 0; r < rows; ++r) {
          if (grid[r][c]) {
            synth.triggerAttackRelease(
              Tone.Frequency(midiNotes[r], "midi"),
              "8n",
              now + c * 0.4
            );
          }
        }
      }
    };

    // --- Save handler ---
    document.getElementById('saveBtn').onclick = async function() {
      const response = await fetch('/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({grid})
      });
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sequence.mid';
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
