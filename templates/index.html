<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grid MIDI Looper</title>
  <link rel="stylesheet" href="/static/style.css">
  <!-- Tone.js for in-browser playback -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>
</head>
<body>
  <h1>Grid MIDI Looper</h1>
  <div style="display: flex; justify-content: center; align-items: flex-start;">
    <div>
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <span style="font-weight: bold;">Track 1</span>
        <select id="track1Instrument" style="margin-left: 12px;">
          {% for opt in instrument_options %}
            <option value="{{ opt.midi }}" {% if opt.midi == track1_instrument %}selected{% endif %}>{{ opt.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="grid1" class="track-grid">
        <table>
          <tbody>
            {% set note_labels = ['C3', '', 'D3', '', 'E3', 'F3', '', 'G3', '', 'A3', '', 'B3', 'C4'] %}
            {% for i in range(note_types|length) %}
              <tr class="{{ note_types[i] }}-key">
                {% if note_types[i] == 'white' %}
                  <td class="note-label">{{ note_labels[i] }}</td>
                {% else %}
                  <td class="note-label"></td>
                {% endif %}
                {% for b in range(beats) %}
                  <td>
                    <div class="cell" data-track="0" data-row="{{ i }}" data-col="{{ b }}"></div>
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="height: 24px;"></div>
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <span style="font-weight: bold;">Track 2</span>
        <select id="track2Instrument" style="margin-left: 12px;">
          {% for opt in instrument_options %}
            <option value="{{ opt.midi }}" {% if opt.midi == track2_instrument %}selected{% endif %}>{{ opt.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="grid2" class="track-grid">
        <table>
          <tbody>
            {% set note_labels = ['C3', '', 'D3', '', 'E3', 'F3', '', 'G3', '', 'A3', '', 'B3', 'C4'] %}
            {% for i in range(note_types|length) %}
              <tr class="{{ note_types[i] }}-key">
                {% if note_types[i] == 'white' %}
                  <td class="note-label">{{ note_labels[i] }}</td>
                {% else %}
                  <td class="note-label"></td>
                {% endif %}
                {% for b in range(beats) %}
                  <td>
                    <div class="cell" data-track="1" data-row="{{ i }}" data-col="{{ b }}"></div>
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div style="margin-left: 24px; display: flex; flex-direction: column; align-items: flex-end;">
      <label for="beatSpeed" style="font-size: 0.95em; margin-bottom: 4px;">
        {{ bpm_label }} BPM:
      </label>
      <input type="number" id="beatSpeed" min="30" max="300" value="{{ beat_speed }}" style="width: 60px;">
    </div>
  </div>
  <div class="controls">
    <button id="playBtn">Play once</button>
    <button id="playLoopBtn">Play (loop)</button>
    <button id="stopBtn">Stop</button>
    <button id="saveBtn">Save as MIDI</button>
    <button id="exportBtn">Export JSON</button>
    <input type="file" id="importInput" accept=".json" style="display:none;">
    <button id="importBtn">Import JSON</button>
    <input type="number" id="addBarCount" min="1" value="1" style="width:40px; margin-left:16px;">
    <button id="addBarBtn">Add bar(s)</button>
    <button id="resetBtn" style="margin-left:16px; color:#b71c1c; font-weight:bold;">Reset</button>
  </div>
  <script>
    // --- Grid state ---
    const rows = {{ note_types|length }};
    let cols = {{ beats }};
    let grids = [
      Array.from({length: rows}, () => Array(cols).fill(0)),
      Array.from({length: rows}, () => Array(cols).fill(0))
    ];

    // Save note_types for use in JS
    window.note_types = {{ note_types|tojson }};

    // --- Cell click handler ---
    function attachCellHandlers() {
      document.querySelectorAll('.cell').forEach(cell => {
        cell.onclick = function() {
          const t = +this.dataset.track, r = +this.dataset.row, c = +this.dataset.col;
          grids[t][r][c] = grids[t][r][c] ? 0 : 1;
          this.classList.toggle('active', !!grids[t][r][c]);
        };
      });
    }
    attachCellHandlers();

    // --- Bold line for every 4 beats (1 bar) ---
    function updateBarLines() {
      document.querySelectorAll('table tr').forEach(row => {
        row.querySelectorAll('td').forEach((td, idx) => {
          if (idx > 0 && ((idx - 1) % 4 === 0)) {
            td.style.borderLeft = "3px solid #333";
          } else if (idx > 0) {
            td.style.borderLeft = "";
          }
        });
      });
    }
    updateBarLines();

    // --- Add bar(s) handler ---
    document.getElementById('addBarBtn').onclick = function() {
      const addBars = parseInt(document.getElementById('addBarCount').value) || 1;
      const addCols = addBars * 4;
      cols += addCols;
      for (let t = 0; t < 2; ++t) {
        for (let r = 0; r < rows; ++r) {
          grids[t][r] = grids[t][r].concat(Array(addCols).fill(0));
        }
      }
      // Re-render the grids in-place, preserving note types and active cells
      ['grid1', 'grid2'].forEach((gridId, t) => {
        const gridDiv = document.getElementById(gridId);
        let html = '<table><tbody>';
        const noteLabels = ['C3', '', 'D3', '', 'E3', 'F3', '', 'G3', '', 'A3', '', 'B3', 'C4'];
        for (let i = 0; i < rows; ++i) {
          html += `<tr class="${window.note_types[i]}-key">`;
          html += `<td class="note-label">${window.note_types[i] === 'white' ? noteLabels[i] : ''}</td>`;
          for (let b = 0; b < cols; ++b) {
            html += `<td><div class="cell${grids[t][i][b] ? ' active' : ''}" data-track="${t}" data-row="${i}" data-col="${b}"></div></td>`;
          }
          html += `</tr>`;
        }
        html += '</tbody></table>';
        gridDiv.innerHTML = html;
      });
      attachCellHandlers();
      updateBarLines();
    };

    // --- Play/Loop/Stop logic ---
    let loopTimeout = null;
    let isLooping = false;
    let stopRequested = false;
    let scheduledIds = [];
    let synths = [];

    async function playSequence(loop=false) {
      await Tone.start();
      const midiNotes = [48,49,50,51,52,53,54,55,56,57,58,59,60];
      const bpm = parseInt(document.getElementById('beatSpeed').value) || 120;
      const beatDur = 60 / bpm;
      const toneInstruments = {
        0: () => new Tone.PolySynth(Tone.Synth).toDestination(),
        40: () => new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" } }).toDestination(),
        24: () => new Tone.PolySynth(Tone.Synth, { oscillator: { type: "square" } }).toDestination(),
        52: () => new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" } }).toDestination()
      };
      const inst1 = parseInt(document.getElementById('track1Instrument').value);
      const inst2 = parseInt(document.getElementById('track2Instrument').value);
      synths = [
        (toneInstruments[inst1] || toneInstruments[0])(),
        (toneInstruments[inst2] || toneInstruments[52])()
      ];

      function scheduleOnePass(startTime) {
        for (let c = 0; c < cols; ++c) {
          for (let t = 0; t < 2; ++t) {
            for (let r = 0; r < rows; ++r) {
              if (grids[t][r][c]) {
                // Only schedule if not stopped
                const scheduledTime = startTime + c * beatDur;
                const id = setTimeout(() => {
                  if (!stopRequested) {
                    synths[t].triggerAttackRelease(
                      Tone.Frequency(midiNotes[r], "midi"),
                      "8n"
                    );
                  }
                }, (scheduledTime - Tone.now()) * 1000);
                scheduledIds.push(id);
              }
            }
          }
        }
      }

      async function loopPlay() {
        if (stopRequested) {
          scheduledIds.forEach(id => clearTimeout(id));
          scheduledIds = [];
          synths.forEach(s => s.releaseAll && s.releaseAll());
          synths.forEach(s => s.dispose());
          return;
        }
        const now = Tone.now();
        scheduleOnePass(now);
        loopTimeout = setTimeout(loopPlay, cols * beatDur * 1000);
      }

      if (loop) {
        stopRequested = false;
        if (loopTimeout) clearTimeout(loopTimeout);
        loopPlay();
      } else {
        stopRequested = false;
        const now = Tone.now();
        scheduleOnePass(now);
        setTimeout(() => {
          synths.forEach(s => s.dispose());
        }, cols * beatDur * 1000 + 500);
      }
    }

    document.getElementById('playBtn').onclick = function() {
      isLooping = false;
      stopRequested = true;
      if (loopTimeout) clearTimeout(loopTimeout);
      // Immediately stop all sounds
      if (synths.length) synths.forEach(s => s.releaseAll && s.releaseAll());
      playSequence(false);
    };

    document.getElementById('playLoopBtn').onclick = function() {
      isLooping = true;
      stopRequested = false;
      if (loopTimeout) clearTimeout(loopTimeout);
      playSequence(true);
    };

    document.getElementById('stopBtn').onclick = function() {
      stopRequested = true;
      if (loopTimeout) clearTimeout(loopTimeout);
      scheduledIds.forEach(id => clearTimeout(id));
      scheduledIds = [];
      if (synths.length) synths.forEach(s => s.releaseAll && s.releaseAll());
    };

    // --- Save handler ---
    document.getElementById('saveBtn').onclick = async function() {
      const inst1 = parseInt(document.getElementById('track1Instrument').value);
      const inst2 = parseInt(document.getElementById('track2Instrument').value);
      const bpm = parseInt(document.getElementById('beatSpeed').value) || 120;
      const response = await fetch('/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({grids: grids, instruments: [inst1, inst2], beats: cols, bpm: bpm})
      });
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sequence.mid';
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    };

    // --- Export handler ---
    document.getElementById('exportBtn').onclick = function() {
      const inst1 = parseInt(document.getElementById('track1Instrument').value);
      const inst2 = parseInt(document.getElementById('track2Instrument').value);
      const bpm = parseInt(document.getElementById('beatSpeed').value) || 120;
      const data = {
        grids: grids,
        instruments: [inst1, inst2],
        bpm: bpm,
        beats: cols
      };
      const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'track_data.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    // --- Import handler ---
    document.getElementById('importBtn').onclick = function() {
      document.getElementById('importInput').click();
    };
    document.getElementById('importInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const data = JSON.parse(evt.target.result);
          if (data.grids && data.grids.length === 2) {
            grids = data.grids;
            cols = data.beats || grids[0][0].length;
            // Re-render the grids in-place, preserving note types and active cells
            ['grid1', 'grid2'].forEach((gridId, t) => {
              const gridDiv = document.getElementById(gridId);
              let html = '<table><tbody>';
              const noteLabels = ['C3', '', 'D3', '', 'E3', 'F3', '', 'G3', '', 'A3', '', 'B3', 'C4'];
              for (let i = 0; i < rows; ++i) {
                html += `<tr class="${window.note_types[i]}-key">`;
                html += `<td class="note-label">${window.note_types[i] === 'white' ? noteLabels[i] : ''}</td>`;
                for (let b = 0; b < cols; ++b) {
                  html += `<td><div class="cell${grids[t][i][b] ? ' active' : ''}" data-track="${t}" data-row="${i}" data-col="${b}"></div></td>`;
                }
                html += `</tr>`;
              }
              html += '</tbody></table>';
              gridDiv.innerHTML = html;
            });
            attachCellHandlers();
            updateBarLines();
          }
          if (data.instruments && data.instruments.length === 2) {
            document.getElementById('track1Instrument').value = data.instruments[0];
            document.getElementById('track2Instrument').value = data.instruments[1];
          }
          if (data.bpm) {
            document.getElementById('beatSpeed').value = data.bpm;
          }
        } catch (err) {
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    // --- Reset handler ---
    document.getElementById('resetBtn').onclick = function() {
      if (confirm('Are you sure you want to reset everything? This will clear all notes, instruments, bars, and BPM.')) {
        // Reset grid, instruments, bpm, bars
        const rows = {{ note_types|length }};
        const defaultBeats = {{ beats }};
        grids = [
          Array.from({length: rows}, () => Array(defaultBeats).fill(0)),
          Array.from({length: rows}, () => Array(defaultBeats).fill(0))
        ];
        cols = defaultBeats;
        document.getElementById('track1Instrument').value = 0;
        document.getElementById('track2Instrument').value = 52;
        document.getElementById('beatSpeed').value = 120;
        // Re-render the grids in-place
        ['grid1', 'grid2'].forEach((gridId, t) => {
          const gridDiv = document.getElementById(gridId);
          let html = '<table><tbody>';
          const noteLabels = ['C3', '', 'D3', '', 'E3', 'F3', '', 'G3', '', 'A3', '', 'B3', 'C4'];
          for (let i = 0; i < rows; ++i) {
            html += `<tr class="${window.note_types[i]}-key">`;
            html += `<td class="note-label">${window.note_types[i] === 'white' ? noteLabels[i] : ''}</td>`;
            for (let b = 0; b < cols; ++b) {
              html += `<td><div class="cell" data-track="${t}" data-row="${i}" data-col="${b}"></div></td>`;
            }
            html += `</tr>`;
          }
          html += '</tbody></table>';
          gridDiv.innerHTML = html;
        });
        attachCellHandlers();
        updateBarLines();
      }
    };
  </script>
</body>
</html>